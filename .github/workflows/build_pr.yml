name: Build Pull Request

on:
  pull_request:
    branches: [main]
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: read

jobs:
  lint:
    uses: ./.github/workflows/_lint.yml
    with:
      python-version: "3.13"

  test:
    uses: ./.github/workflows/_test.yml
    with:
      coverage_package: "langchain_a2a_adapters"
      python-versions: '["3.10","3.11","3.12","3.13"]'
      coverage_python: "3.13"

  build:
    uses: ./.github/workflows/_build.yml
    with:
      python-version: "3.13"

  coverage:
    name: Upload coverage to DeepSource
    runs-on: ubuntu-latest
    needs: [lint, test, build]

    steps:
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-xml

      - name: Install DeepSource CLI
        run: curl -sSL https://deepsource.io/cli | sh

      - name: Upload coverage
        env:
          DEEPSOURCE_DSN: ${{ secrets.DEEPSOURCE_DSN }}
        run: |
          ./bin/deepsource report \
            --analyzer test-coverage \
            --key python \
            --value-file coverage.xml
